<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privy Wallet</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .wallet-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .wallet-info h3 {
            margin-top: 0;
            color: #333;
        }
        .wallet-address {
            word-break: break-all;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #4f46e5;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app">
            <div class="loading">Loading Privy...</div>
        </div>
    </div>

    <script>
        const PRIVY_APP_ID = 'cmhsxw209010cl50clkljmd4o';
        const PRIVY_BASE_URL = 'https://auth.privy.io';

        let currentUser = null;

        // Initialize Privy
        async function initPrivy() {
            try {
                console.log('Initializing Privy with App ID:', PRIVY_APP_ID);

                // Check if we have a stored session
                const storedUser = localStorage.getItem('privy_user');
                if (storedUser) {
                    try {
                        currentUser = JSON.parse(storedUser);
                    } catch (e) {
                        console.error('Error parsing stored user:', e);
                    }
                }

                updateUI();
                sendMessageToFlutter('privy_ready', { ready: true });
            } catch (error) {
                console.error('Error initializing Privy:', error);
                sendMessageToFlutter('privy_error', { error: error.message });
            }
        }

        // Login with Privy
        async function login() {
            try {
                sendMessageToFlutter('login_started', {});

                // Open Privy login in a new window or redirect
                // For mobile WebView, we'll use an iframe approach
                const loginUrl = `${PRIVY_BASE_URL}/login?app_id=${PRIVY_APP_ID}`;

                console.log('Opening Privy login:', loginUrl);

                // Create a modal with iframe for Privy login
                const modal = document.createElement('div');
                modal.id = 'privy-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 90%; max-width: 500px; height: 80%; background: white; border-radius: 12px; overflow: hidden; position: relative;">
                            <button onclick="closePrivyModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10000; background: #f0f0f0; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px;">Ã—</button>
                            <iframe id="privy-iframe" src="${loginUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Listen for messages from the iframe
                window.addEventListener('message', handlePrivyMessage);

            } catch (error) {
                console.error('Login error:', error);
                sendMessageToFlutter('login_error', { error: error.message });
            }
        }

        // Handle messages from Privy iframe
        function handlePrivyMessage(event) {
            console.log('Received message:', event);

            // Check if message is from Privy
            if (event.origin !== PRIVY_BASE_URL) {
                return;
            }

            try {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                if (data.type === 'privy:login:success') {
                    // User successfully logged in
                    currentUser = {
                        id: data.user?.id,
                        wallet: {
                            address: data.user?.wallet?.address
                        },
                        email: data.user?.email
                    };

                    // Store user in localStorage
                    localStorage.setItem('privy_user', JSON.stringify(currentUser));

                    closePrivyModal();
                    updateUI();
                    sendMessageToFlutter('login_success', { user: currentUser });
                }
            } catch (error) {
                console.error('Error handling Privy message:', error);
            }
        }

        // Close Privy modal
        function closePrivyModal() {
            const modal = document.getElementById('privy-modal');
            if (modal) {
                modal.remove();
                window.removeEventListener('message', handlePrivyMessage);
            }
        }

        // Logout
        async function logout() {
            try {
                currentUser = null;
                updateUI();
                sendMessageToFlutter('logout_success', {});
            } catch (error) {
                console.error('Logout error:', error);
                sendMessageToFlutter('logout_error', { error: error.message });
            }
        }

        // Update UI based on connection status
        function updateUI() {
            const app = document.getElementById('app');

            if (currentUser) {
                app.innerHTML = `
                    <div class="wallet-info">
                        <div class="status connected">Connected</div>
                        <h3>Wallet Connected</h3>
                        <p>Address:</p>
                        <div class="wallet-address">${currentUser.wallet?.address || 'N/A'}</div>
                        <button onclick="logout()">Disconnect</button>
                    </div>
                `;
            } else {
                app.innerHTML = `
                    <div class="wallet-info">
                        <div class="status disconnected">Not Connected</div>
                        <h3>Connect Your Wallet</h3>
                        <p>Connect with Privy to get started</p>
                        <button onclick="login()">Connect Wallet</button>
                    </div>
                `;
            }
        }

        // Send message to Flutter
        function sendMessageToFlutter(event, data) {
            const message = JSON.stringify({ event, data });

            // For Flutter WebView
            if (window.FlutterChannel) {
                window.FlutterChannel.postMessage(message);
            }

            // Also log to console
            console.log('Message to Flutter:', event, data);
        }

        // Handle messages from Flutter
        function handleFlutterMessage(message) {
            console.log('Message from Flutter:', message);

            try {
                const { action, data } = JSON.parse(message);

                switch (action) {
                    case 'login':
                        login();
                        break;
                    case 'logout':
                        logout();
                        break;
                    case 'get_user':
                        sendMessageToFlutter('user_data', { user: currentUser });
                        break;
                    case 'user_connected':
                        // User successfully connected through Privy
                        currentUser = data.user;
                        updateUI();
                        sendMessageToFlutter('login_success', { user: currentUser });
                        break;
                    default:
                        console.warn('Unknown action:', action);
                }
            } catch (error) {
                console.error('Error handling Flutter message:', error);
            }
        }

        // Initialize when page loads
        window.onload = initPrivy;

        // Expose function for Flutter to call
        window.handleFlutterMessage = handleFlutterMessage;
    </script>
</body>
</html>
